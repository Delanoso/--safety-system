generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Appointment {
  id                 String   @id @default(cuid())
  type               String
  appointee          String
  appointer          String
  department         String
  date               DateTime
  status             String   @default("draft")

  appointeeEmail     String?
  appointerEmail     String?

  appointeeSignature String?
  appointerSignature String?

  appointeeSignedAt  DateTime?
  appointerSignedAt  DateTime?

  appointeeToken     String?
  appointerToken     String?
}

model Inspection {
  id          String   @id        // frontend-controlled ID
  type        String
  department  String
  inspector   String
  createdAt   DateTime @default(now())
  data        String   // JSON
}

model DailyInspection {
  id          String   @id        // frontend-controlled ID
  department  String
  inspector   String
  createdAt   DateTime @default(now())
  data        String   // JSON: { columns, legendItems, rows }
}

model WeeklyInspection {
  id          String   @id        // frontend-controlled ID
  department  String
  inspector   String
  createdAt   DateTime @default(now())
  data        String   // JSON: { columns, legendItems, rows }
}

model MonthlyInspection {
  id          String   @id        // frontend-controlled ID
  department  String
  inspector   String
  createdAt   DateTime @default(now())
  data        String   // JSON: { columns, legendItems, rows }
}

model NcrReport {
  id              String     @id @default(cuid())
  createdAt       DateTime   @default(now())
  department      String?
  status          String     @default("open")
  items           NcrItem[]

  // Multi-tenant ownership
  company         Company?   @relation(fields: [companyId], references: [id])
  companyId       String?

  createdBy       User?      @relation(fields: [createdByUserId], references: [id])
  createdByUserId String?
}

model NcrItem {
  id          String    @id @default(cuid())
  description String
  date        DateTime
  comment     String?
  department  String?
  report      NcrReport @relation(fields: [reportId], references: [id])
  reportId    String
  images      NcrImage[]
}

model NcrImage {
  id     String  @id @default(cuid())
  url    String
  item   NcrItem @relation(fields: [itemId], references: [id])
  itemId String
}

model Incident {
  id              String                    @id @default(cuid())
  type            String
  title           String
  description     String?
  department      String?
  employee        String?
  employeeId      String?
  location        String?
  date            DateTime
  severity        String
  status          String                    @default("draft")
  linkId          String?

  // JSON stored as TEXT
  details         String?

  images          IncidentImage[]
  team            InvestigationTeamMember[]   // relation to team members
  costAnalyses    CostAnalysis[]
  documents       IncidentDocument[]

  company         Company?                    @relation(fields: [companyId], references: [id])
  companyId       String?

  // Which user created this incident
  createdBy       User?                       @relation(fields: [createdByUserId], references: [id])
  createdByUserId String?

  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
}

model IncidentImage {
  id         String   @id @default(cuid())
  url        String
  incident   Incident @relation(fields: [incidentId], references: [id])
  incidentId String
  createdAt  DateTime @default(now())
}

model CostAnalysis {
  id          String    @id @default(cuid())
  linkId      String?
  incident    Incident? @relation(fields: [incidentId], references: [id])
  incidentId  String?
  directCost  Float?
  indirectCost Float?
  otherCost   Float?
  totalCost   Float?
  notes       String?
  createdAt   DateTime  @default(now())
}

model IncidentDocument {
  id         String    @id @default(cuid())
  title      String
  fileName   String
  fileType   String
  filePath   String
  linkId     String?
  incident   Incident? @relation(fields: [incidentId], references: [id])
  incidentId String?
  uploadedAt DateTime  @default(now())
}

model Company {
  id          String      @id @default(cuid())
  name        String
  logoUrl     String?
  brandColor  String?

  // Maximum number of users allowed for this company
  userLimit   Int         @default(5)

  // Relations
  incidents   Incident[]
  ncrReports  NcrReport[]
  users       User[]

  // Health & Safety modules
  sheCommitteeMeetings  SHECommitteeMeeting[]
  sheElections          SHEElection[]
  riskAssessments       RiskAssessment[]
  hazardousChemicals    HazardousChemical[]
  contractors           Contractor[]
  maintenanceSchedules  MaintenanceSchedule[]
}

model InvestigationTeamMember {
  id          String    @id @default(cuid())
  name        String
  designation String
  signature   String?

  incident    Incident  @relation(fields: [incidentId], references: [id])
  incidentId  String

  createdAt   DateTime  @default(now())
}

model SignatureToken {
  id          String   @id @default(cuid())
  token       String   @unique
  teamId      String
  incidentId  String
  createdAt   DateTime @default(now())
  expiresAt   DateTime
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String

  /// Role within the system: "user" | "admin" | "super"
  role      String   @default("user")

  createdAt DateTime @default(now())

  // Tenant membership
  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  ncrReports NcrReport[]
  incidents  Incident[]
}

model Folder {
  id        String   @id @default(cuid())
  name      String
  section   String
  files     File[]
  createdAt DateTime @default(now())
}

model File {
  id        String   @id @default(cuid())
  name      String
  url       String
  size      Int?
  folderId  String
  folder    Folder   @relation(fields: [folderId], references: [id])
  createdAt DateTime @default(now())
}

model Certificate {
  id             Int      @id @default(autoincrement())
  employee       String
  certificateName String
  certificateType String?
  issueDate      DateTime
  expiryDate     DateTime
  notes          String?
  fileUrl        String?   // Cloudinary or local storage
  createdAt      DateTime  @default(now())
}

model Medical {
  id          Int       @id @default(autoincrement())
  employee    String
  medicalType String    // e.g. Baseline Medical, Audiometry, Fitness for Duty
  issueDate   DateTime
  expiryDate  DateTime
  notes       String?
  fileUrl     String?
  createdAt   DateTime  @default(now())
}

// PPE Management
model PPEPerson {
  id        Int       @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  department     String?
  subDepartment  String?
  sizes     String?   // JSON e.g. {"Shoes":"42","Gloves":"M"}
  issues    PPEIssue[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model PPEItemType {
  id        Int        @id @default(autoincrement())
  name      String     // Shoes, Gloves, Helmet, etc.
  stock     PPEStock?
  issues    PPEIssue[]
  createdAt DateTime   @default(now())
}

model PPEStock {
  id          Int         @id @default(autoincrement())
  itemTypeId  Int         @unique
  itemType    PPEItemType @relation(fields: [itemTypeId], references: [id], onDelete: Cascade)
  quantity    Int         @default(0)
  updatedAt   DateTime    @updatedAt
}

model PPEIssue {
  id         Int         @id @default(autoincrement())
  personId   Int
  person     PPEPerson   @relation(fields: [personId], references: [id], onDelete: Cascade)
  itemTypeId Int
  itemType   PPEItemType @relation(fields: [itemTypeId], references: [id], onDelete: Cascade)
  quantity   Int         @default(1)
  issueDate  DateTime    @default(now())
  signature  String?     // data URL
  signedAt   DateTime?
  signToken  String?     // for email/SMS link
  status     String      @default("pending_signature") // pending_signature | signed
  createdAt  DateTime    @default(now())
}

// SHE Committee
model SHECommitteeMeeting {
  id          String   @id @default(cuid())
  date        DateTime
  agenda      String?
  minutes     String?
  attendees   String?  // JSON array of names
  actionItems String?  // JSON array of {description, assignee, dueDate}
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  createdAt   DateTime @default(now())
}

// SHE Rep Election
model SHEElection {
  id          String   @id @default(cuid())
  title       String
  status      String   @default("draft") // draft | voting_open | voting_closed
  startDate   DateTime?
  endDate     DateTime?
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  candidates  SHEElectionCandidate[]
  voters      SHEElectionVoter[]
  createdAt   DateTime @default(now())
}

model SHEElectionCandidate {
  id        String      @id @default(cuid())
  election  SHEElection @relation(fields: [electionId], references: [id], onDelete: Cascade)
  electionId String
  name      String
  department String?
  votes     SHEElectionVoter[]
  createdAt DateTime    @default(now())
}

model SHEElectionVoter {
  id          String              @id @default(cuid())
  election    SHEElection         @relation(fields: [electionId], references: [id], onDelete: Cascade)
  electionId  String
  email       String?
  phone       String?
  voteToken   String   @unique     // unique link token
  candidateId String?
  candidate   SHEElectionCandidate? @relation(fields: [candidateId], references: [id])
  votedAt     DateTime?
  createdAt   DateTime @default(now())
}

// Risk Assessments
model RiskAssessment {
  id              String    @id @default(cuid())
  title           String
  department      String?
  location        String?
  assessor        String?
  riskLevel       String    // low, medium, high, critical
  reviewDate      DateTime?
  controls        String?   // risk controls / mitigations
  fileUrl         String?
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id])
  industrySector  String?   // e.g. Manufacturing, Construction
  assessmentType  String?   // e.g. General, Task-based, COSHH
  description     String?   // user input for AI generation
  signature       String?   // data URL
  signedAt        DateTime?
  status          String    @default("draft") // draft | signed
  createdAt       DateTime  @default(now())
}

// Hazardous Chemicals
model HazardousChemical {
  id          String   @id @default(cuid())
  name        String
  casNumber   String?  // Chemical Abstract Service number
  location    String?
  quantity    String?
  unit        String?
  sdsUrl      String?  // Safety Data Sheet link
  hazardClass String?
  notes       String?
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  createdAt   DateTime @default(now())
}

// Contractors Portal – safety file for on-site work
model Contractor {
  id              String   @id @default(cuid())
  name            String   // Company/business name
  contactEmail    String?
  contactPhone    String?
  scope           String   @default("ongoing") // specific_job | ongoing
  jobDescription  String?  // For specific job: description of work
  uploadToken     String   @unique // Token for contractor upload link
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id])
  documents       ContractorDocument[]
  createdAt       DateTime @default(now())
}

model ContractorDocument {
  id                   String    @id @default(cuid())
  contractor           Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  contractorId         String
  section              String    // e.g. insurance, risk_assessments
  fileName             String
  fileUrl              String
  uploadedByContractor Boolean   @default(false)
  createdAt            DateTime  @default(now())
}

// Maintenance Schedule – trucks, machinery, lifting equipment, other
model MaintenanceSchedule {
  id        String   @id @default(cuid())
  title     String   // e.g. "Fleet Trucks", "Factory Machinery"
  type      String   // trucks | machinery | lifting_equipment | other
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  items     MaintenanceItem[]
  createdAt DateTime @default(now())
}

model MaintenanceItem {
  id         String   @id @default(cuid())
  schedule   MaintenanceSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId String
  equipmentId String  // User ID e.g. reg number, asset tag
  data       String   // JSON – type-specific fields
  services   MaintenanceService[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model MaintenanceService {
  id              String   @id @default(cuid())
  item            MaintenanceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId          String
  serviceDate     DateTime
  description     String?  // What was done
  meterReading    Float?   // Odometer or hours at time of service
  nextDueDate     DateTime?
  performedBy     String?
  notes           String?
  createdAt       DateTime @default(now())
}

